stages:
  - preflight
  - test

# Generic preflight template
.preflight: &preflight
  stage: preflight
  tags:
    - preflight

# Generic test template
.test: &test
  stage: test
  image: homeassistant/amd64-homeassistant
  before_script:
    - cp travis_secrets.yaml secrets.yaml
    - touch ./home-assistant_v2.db
    - touch ./home-assistant.log
    - touch ./OZW_Log.txt
  script:
    - hass --script check_config -c .
  tags:
    - test

# Preflight jobs
shellcheck:
  <<: *preflight
  image:
    name: koalaman/shellcheck-alpine:stable
    entrypoint: [""]
  before_script:
    - shellcheck --version
    - apk --no-cache add grep
    - |
      find . -type f -print0 | \
        xargs -0 sed -i 's:#!/usr/bin/with-contenv bash:#!/bin/bash:g'
  script:
    - |
      for file in $(grep -IRl "#\!\(/usr/bin/env \|/bin/\)" --exclude-dir ".git" "${ADDON_TARGET}"); do
        if ! shellcheck $file; then
          export FAILED=1
        else
          echo "$file OK"
        fi
      done
      if [ "${FAILED}" = "1" ]; then
        exit 1
      fi

# Test jobs
latest:
  <<: *test
  image:
    name: homeassistant/home-assistant:latest
    entrypoint: [""]

rc:
  <<: *test
  image:
    name: homeassistant/home-assistant:rc
    entrypoint: [""]
  allow_failure: true

dev:
  <<: *test
  image:
    name: homeassistant/home-assistant:dev
    entrypoint: [""]
  allow_failure: true